{{define "article" -}}
    {{- $pageDepth := 0 -}}
    {{- $data := dict "currUser" .LoginedUser "article" .Data.Article "pageType" .Data.PageType "pageDepth" $pageDepth "CSRFField" .CSRFField "maxDepth" .Data.MaxDepth "debug" .Debug "reactOptions" .Data.ReactOptions "reactMap" .Data.ReactMap -}}

    {{template "head" . -}}

    <style>
     article > section{
	 padding-bottom: 4px;
     }
     .replies{
	 margin-top: 0;
	 list-style:none;
	 margin-left:0;
	 padding-left: 0;
     }

     .replies li>.replies{
	 padding-left: var(--reply-indent-size);
	 border-left: 1px dashed var(--border-color);
     }
     .replies li{
	 border: 1px solid transparent;
     }
     .replies li>article{
	 padding: 5px 0;
	 border-bottom: 1px dashed transparent;
     }
     .replies li>article:hover{
	 background: var(--background-hover);
     }
     
     .replies li:focus,
     .replies li.active,
     .replies li:target{
	 border: 1px solid var(--border-color);
     }
     .replies li.active>.replies,
     .replies li:target>.replies{
	 border-left-color: transparent;
     }
     .replies li.active>article,
     .replies li:target>article{
	 border-bottom: 1px dashed var(--border-color)
     }
     .reply-tab{
	 display: flex;
	 margin-top: 16px;
	 flex-wrap: wrap;
	 justify-content: space-between;
	 border-bottom: 1px solid var(--border-color)
     }
     .reply-tab .reply-tab__title{
	 font-weight: bold;
	 line-height: 32px;
     }

     .reply-tab .tabs{
	 margin-bottom: -1px;
	 border-bottom-color: transparent;
     }
    </style>

    {{template "article_content" $data -}}

    {{- if and $data.article.Replies (gt $data.article.Replies.TotalPage 1) -}}
	{{- $prefix := printf "/articles/%d" $data.article.Id -}}
	{{- $pagiData := dict "currPage" $data.article.Replies.CurrPage "totalPage" $data.article.Replies.TotalPage "pathPrefix" $prefix -}}
	{{- template "pagination" $pagiData -}}
    {{- end -}}

    <script>
     const WIDTH_MOBILE = 750;
     var isMobile = window.innerWidth <= WIDTH_MOBILE

     window.addEventListener('resize', function(e){
	 isMobile = window.innerWidth <= WIDTH_MOBILE
     })
     
     document.documentElement.addEventListener('mouseup', function(ev){
	 /* console.log(ev) */
	 var replyBox = document.getElementById('replies-box')
	 if (replyBox && !replyBox.contains(ev.target)) {
	     removeAllActive('li', replyBox)
	 }
     })

     var replyBox = document.getElementById('replies-box')
     var ignoreTags = ['a', 'button', 'select']
     if (replyBox){
	 replyBox.addEventListener('mousedown', function(ev){
	     /* console.log('ev', ev) */
	     var targetTag = ev.target.tagName.toLowerCase()
	     if (ignoreTags.indexOf(targetTag) > -1) return
	     
	     var row = ev.target.closest('li')
	     if (row) {
		 onArticleMouseDown(ev, row)
	     }
	 })
     }

     function removeAllActive(tagName, parentNode){
	 var parent = parentNode || document
	 var els = parent.getElementsByTagName(tagName)
	 for (var i = 0; i < els.length; i++){
	     removeClass(els[i], 'active')
	 }
     }

     // return previous display or not
     function toggleDisplayEl(el, toDisplay){
	 var flag = el.style.display == 'none'
	 if (typeof toDisplay == 'boolean'){
	     flag = toDisplay
	 }
	 
	 if (flag){
	     el.style.display = ''
	     return false
	 } else {
	     el.style.display = 'none'
	     return true
	 }
     }
     
     function toggleDisplayContent(rowEl, toFold){
	 var content = rowEl.getElementsByTagName('section')[0]
	 var operation = rowEl.getElementsByClassName('article-operation')[0]
	 var id = rowEl.getAttribute('data-id')
	 
	 if (content){
	     var isDisplay = checkDisplay(content)
	     var placeholderId = 'article_placeholder_' + id
	     var placeholder

	     var replyNumText = rowEl.getAttribute('data-reply-num-self-include-text')

	     var flag = isDisplay
	     if (typeof toFold == 'boolean'){
		 flag = toFold
	     }

	     toggleDisplayEl(content, !flag)
	     toggleDisplayEl(operation, !flag)
	     
	     if (flag){
		 placeholder = document.createElement('div')
		 placeholder.setAttribute('id', placeholderId)
		 placeholder.className='article-placeholder text-lighten-2'
		 placeholder.innerHTML = '&nbsp;&nbsp;<i>'+ replyNumText +'</i>'
		 content.parentNode.insertBefore(placeholder, content)

		 rowEl.setAttribute('data-hidden', 1)
	     } else {
		 placeholder = document.getElementById(placeholderId)
		 if (placeholder) placeholder.remove()

		 rowEl.removeAttribute('data-hidden')
	     }
	 }
	 
	 var child = rowEl.getElementsByTagName('ul')[0]
	 if (child){
	     toggleDisplayEl(child, !flag)
	 }

	 /* console.log('isMobile', isMobile) */

	 if (isMobile && toFold){
	     window.scrollTo({
		 top: rowEl.getBoundingClientRect().top + document.documentElement.scrollTop,
		 behavior: 'smooth'
	     })
	 }
     }

     function toggleActive(el){
	 var isActive = hasClass(el, 'active')
	 var isHidden = !!el.getAttribute("data-hidden")
	 
	 removeAllActive('li', document.getElementById('replies-box'))
	 addClass(el, 'active')
	 
	 if (isHidden){
	     toggleDisplayContent(el)
	 }
     }

     function checkDisplay(el){
	 return el.style.display != 'none'
     }

     function hasClass(el, className){
	 return el.className.split(" ").indexOf(className) > -1
     }
     
     function removeClass(el, className){
	 if(hasClass(el, className)){
	     el.className = el.className.replace(className, '')
	 }
     }

     function addClass(el, className){
	 if(!hasClass(el, className)){
	     el.className += " " + className
	 }
	 
     }

     function onArticleMouseDown(ev, rowEl){
	 function onArticleMouseUp(){
	     /* console.log(ev, el) */
	     event.preventDefault()
	     event.stopPropagation()

	     toggleActive(rowEl)

	     // if (hasClass(rowEl, 'active')){
		 // toggleDisplayContent(rowEl)
	     // } else {
		 // toggleActive(rowEl)
	     // }
	 }
	 
	 rowEl.onmouseup = onArticleMouseUp
	 setTimeout(function(){
	     rowEl.onmouseup = null
	 }, 300)
     }

     function scrollToElementById(ev, id){
	 ev.preventDefault()
	 ev.stopPropagation()
	 var el = document.getElementById(id)
	 /* console.log(ev, el) */
	 if (el){
	     setTimeout(function(){
		 location.hash = id
	     }, 500)
	     window.scrollTo({
		 top: el.getBoundingClientRect().top + document.documentElement.scrollTop,
		 behavior: 'smooth',
	     })
	 }
     }

     function onReplyFormKeyUp(ev, form) {
	 /* console.log(ev) */
	 if (ev.isTrusted && ev.ctrlKey && ev.code == 'Enter'){
	     form.submit()
	 }
     }

     function onReactChange(ev, sel) {
	 /* console.log(sel.value) */
	 /* sel.style.visibility = "hidden" */
	 sel.closest('form').submit()
	 sel.value = ""
     }
    </script>

    {{template "foot" -}}
{{- end -}}

{{define "article_content" -}}
    {{$isRoot := eq .article.ReplyDepth 0 -}}
    {{$pageDepth := add .pageDepth 1 -}}
    {{$delPage := eq .pageType "del"}}
    {{$replyPage := eq .pageType "reply"}}
    {{$data := dict "currUser" .currUser "article" .article "pageDepth" $pageDepth "CSRFField" .CSRFField "maxDepth" .maxDepth "isRootArticle" $isRoot "debug" .debug "reactOptions" .reactOptions "reactMap" .reactMap -}}
    <article {{if $isRoot}}id="ar_{{.article.Id}}"{{end}}>
	{{if $isRoot -}}
	    <h1>{{.article.Title}}</h1>
	{{else -}}
	    {{if eq $pageDepth 1 -}}
		<h1>Re{{if gt .article.ReplyDepth 1}} &times; {{.article.ReplyDepth}}{{- end -}}: <a href="/articles/{{.article.ReplyRootArticleId}}">{{.article.ReplyRootArticleTitle}}</a></h1>
	    {{- end -}}
	{{- end -}}

	<div class="text-lighten-3" style="margin-bottom:0px;">
	    <small>
		{{- if .article.Deleted -}}
		    <span>deleted</span>&nbsp;
		{{- else -}}
		    <a class="text-lighten-3" href="/users/{{.article.AuthorId}}">{{.article.AuthorName}}</a>&nbsp;
		{{- end -}}
		published <time title="{{.article.CreatedAt}}">{{timeAgo .article.CreatedAt}}</time> |&nbsp;
		{{- if ne .article.CreatedAt .article.UpdatedAt -}}
		    modified <time title="{{.article.UpdatedAt}}">{{timeAgo .article.UpdatedAt}}</time> |&nbsp;
		{{- end -}}
		<a class="text-lighten-3" href="/articles/{{.article.Id}}">link</a> |&nbsp;
		<a class="text-lighten-3" href="#ar_{{.article.Id}}">anchor</a> |&nbsp;
		<span>{{- local "ReplyNum" "Count" .article.TotalReplyCount -}}</span>&nbsp;
		{{- if .article.Replies -}}
		    |&nbsp;{{.article.Replies.Total}} children&nbsp;
		{{- end -}}
		{{- if .debug -}}
		    |&nbsp;{{- .article.ReplyDepth}} depth
		    |&nbsp;{{- .article.Weight}} weight
		{{- end -}}
	    </small>
	</div>
	{{if .article.Deleted -}}
	    <i class="text-lighten-2">&lt;Deleted&gt;</i>
	{{- else -}}
	    <section style="white-space: break-spaces">{{- .article.Content -}}</section>
	{{- end -}}

	{{if not $delPage -}}
	    {{template "article_operation_bar" $data -}}
	{{- end -}}
    </article>

    {{if and $delPage .currUser -}}
	<form method="post" action="/articles/{{.article.Id}}/delete{{if gt .pageDepth 1}}?from=reply{{- end}}" id="del_form_{{.article.Id}}" style="margin:12px 0 12px;padding:10px;border:1px solid #ccc;">
	    {{.CSRFField -}}
	    <input type="hidden" name="id" value="{{.article.Id}}">
	    <label for="confirm_del">Confirm to delete?</label>
	    <br/>
	    <br/>
	    <button type="submit">Delete</button>
	</form>
    {{- else -}}
	{{if eq .pageDepth 0 -}}
	    {{if .currUser -}}
		{{if and (not .article.Deleted) $replyPage -}}
		    {{template "article_reply_form" $data -}}
		{{- end -}}
	    {{- end -}}
	    
	    {{- if and (gt .article.TotalReplyCount 0) (not $replyPage) -}}
		<div id="replies" class="reply-tab">
		    <div class="reply-tab__title">{{local "ReplyNum" "Count" .article.TotalReplyCount}}</div>
		    {{- $article := .article -}}
		    {{- $sortTabs := list "best" "latest" -}}
		    {{- $sortTabMap := dict "best" "Best" "latest" "Latest" -}}
		    <div class="tabs">
			{{- range $sortTabs -}}
			    {{- if eq $article.Replies.SortType . -}}
				<span class="tab active">{{get $sortTabMap .}}</span>
			    {{- else -}}	
				<a class="tab" href="/articles/{{$article.Id}}{{if ne . "best"}}?sort={{.}}#replies{{end}}">{{get $sortTabMap .}}</a>
			    {{- end -}}
			{{- end -}}
		    </div>
		</div>
	    {{- end -}}
	{{- end -}}

	{{- if and .article.Replies (not $replyPage) -}}
	    {{$replyData := dict "currUser" .currUser "replies" .article.Replies "pageDepth" $pageDepth "CSRFField" .CSRFField "maxDepth" .maxDepth "debug" .debug "reactOptions" .reactOptions "reactMap" .reactMap -}}
	    {{template "article_replies" $replyData -}}
	{{- end -}}
    {{- end -}}

{{- end -}}

<!-- svg icon license -->
<!-- https://github.com/Templarian/MaterialDesign/blob/master/LICENSE -->
<!-- https://github.com/radix-ui/icons/blob/master/LICENSE -->

{{define "article_operation_bar" -}}
    <div class="article-operation">
	<small>
	    {{- if not .article.Deleted -}}
		<form class="vote-form{{if eq .article.CurrUserState.VoteType "up"}} voted{{end}}" action="/articles/{{.article.Id}}/vote" method="POST">
		    {{.CSRFField}}
		    <input name="root" type="hidden" value="{{.article.ReplyRootArticleId}}"/>
		    <input name="type" type="hidden" value="up"/>
		    <button class="btn-vote--up" type="submit" title="Upvote"><svg width="14" viewBox="0 1 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" d="M1 21h22L12 2"/></svg></button>
		</form>
		{{- if gt .article.VoteScore 0 -}}
		    <span>{{.article.VoteScore}}<span>
		{{- end -}}
		<form class="vote-form{{if eq .article.CurrUserState.VoteType "down"}} voted{{end}}" action="/articles/{{.article.Id}}/vote" method="POST">
		    {{.CSRFField}}
		    <input name="root" type="hidden" value="{{.article.ReplyRootArticleId}}"/>
		    <input name="type" type="hidden" value="down"/>
		    <button class="btn-vote--down" type="submit" title="Downvote"><svg width="14" viewBox="0 1 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" d="M1 3h22L12 22"/></svg></button>
		</form>&nbsp;
		{{- if .currUser -}}
		    {{- if eq .currUser.Id .article.AuthorId -}}
			<a href="/articles/{{.article.Id}}/edit" class="btn-edit">Edit</a>&nbsp;&nbsp;<a class="btn-del" href="/articles/{{.article.Id}}/delete">Delete</a>&nbsp;&nbsp;
		    {{- end -}}
		    <form class="btn-form" action="/articles/{{.article.Id}}/save" method="POST" >
			{{- .CSRFField -}}
			<button title="Save" type="submit">{{- if and .article.CurrUserState .article.CurrUserState.Saved -}}
			    Unsave
			{{- else -}}
			    Save
			{{- end -}}</button>
		    </form>&nbsp;&nbsp;
		{{- end -}}
		<a title="Reply" href="/articles/{{.article.Id}}/reply">Reply</a>&nbsp;&nbsp;

		{{- if gt .pageDepth 1 -}}
		    <a title="Parent" href="#ar_{{.article.ReplyTo}}" onclick="scrollToElementById(event, 'ar_{{.article.ReplyTo}}')">Parent</a>&nbsp;&nbsp;
		{{- end -}}
	    {{- end -}}
	    {{- if and (eq .pageDepth 1) (not .isRootArticle) -}}
		<a title="Parent" href="/articles/{{.article.ReplyTo}}">Parent</a>&nbsp;&nbsp;
	    {{- end -}}
	</small>

	<small>
	    {{- if not .article.Deleted -}}
		{{- $reactOptions := .reactOptions -}}
		{{- $reactMap := .reactMap -}}
		{{- $article := .article -}}
		{{- $currReactType := "" -}}
		{{- $currUser := .currUser -}}
		{{- $csrfField := .CSRFField -}}
		{{- $reactDescribeMap := dict "grinning" "Haha" "thanks" "Thanks" "confused" "Confuse" "eyes" "Watching" "party" "Yeah" -}}
		{{- if and .article.CurrUserState .article.CurrUserState.ReactType -}}
		    {{- $currReactType = .article.CurrUserState.ReactType -}}
		{{- end -}}
		<div class="article-reacts">
		    {{- range $reactOptions -}}
			{{- if gt (index $article.ReactCounts .) 0 -}}
			    {{- if $currUser -}}
				<form class="btn-form btn-react" action="/articles/{{$article.Id}}/react" method="POST">
				    {{$csrfField}}
				    <input name="root" type="hidden" value="{{$article.ReplyRootArticleId}}"/>
				    <input name="react" type="hidden" value="{{.}}"/>
				    {{- $strVal := . | toString -}}
				    {{if eq $currReactType .}}
					<button type="submit" title="{{get $reactDescribeMap $strVal}}" class="btn-react__selected">{{index $reactMap .}}</button>{{index $article.ReactCounts .}}&nbsp;&nbsp;
				    {{- else -}}
					<button type="submit" title="{{get $reactDescribeMap $strVal}}">{{index $reactMap .}}</button>{{index $article.ReactCounts .}}&nbsp;&nbsp;
				    {{- end -}}
				</form>
			    {{- else -}}
				<span>{{index $reactMap .}}{{index $article.ReactCounts .}}</span>&nbsp;&nbsp;
			    {{- end -}}
			{{- end -}}
		    {{- end -}}
		</div>
		
		{{- if .currUser -}}
		    <!-- <a href="/articles/{{.article.Id}}/thanks" title="Thanks"><svg width="16" viewBox="0 -1 16 16" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" fill-rule="evenodd" d="M1.352 4.905a3.547 3.547 0 0 1 3.541-3.553c1.365 0 1.968.571 2.607 1.583c.64-1.012 1.242-1.583 2.607-1.583a3.547 3.547 0 0 1 3.54 3.553c0 1.835-1.046 3.6-2.246 5.064c-1.137 1.387-2.48 2.582-3.395 3.397l-.173.155a.5.5 0 0 1-.666 0l-.173-.155c-.916-.815-2.258-2.01-3.395-3.397C2.4 8.505 1.352 6.74 1.352 4.905Z" clip-rule="evenodd"/></svg></a>&nbsp;&nbsp; -->
		    <form class="btn-form btn-react" action="/articles/{{.article.Id}}/react" method="POST">
			{{.CSRFField}}
			<input name="root" type="hidden" value="{{.article.ReplyRootArticleId}}"/>
			<span title="Emoji">
			    <svg width="16" viewBox="0 -2 16 16" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" fill-rule="evenodd" d="M7.5.877a6.623 6.623 0 1 0 0 13.246A6.623 6.623 0 0 0 7.5.877ZM1.827 7.5a5.673 5.673 0 1 1 11.346 0a5.673 5.673 0 0 1-11.346 0Zm3.21 1.714a.5.5 0 1 0-.82.572A3.996 3.996 0 0 0 7.5 11.5c1.36 0 2.56-.679 3.283-1.714a.5.5 0 0 0-.82-.572A2.996 2.996 0 0 1 7.5 10.5a2.996 2.996 0 0 1-2.463-1.286Zm.338-2.364a.875.875 0 1 0 0-1.75a.875.875 0 0 0 0 1.75Zm5.125-.875a.875.875 0 1 1-1.75 0a.875.875 0 0 1 1.75 0Z" clip-rule="evenodd"/></svg>
			    <select required title="Reaction" id="react_{{$article.Id}}" name="react" autocomplete="off" onchange="onReactChange(event, this)">
				<option value="" selected hidden disabled></option>
				{{- range .reactOptions -}}
				    <option value="{{.}}">{{index $reactMap .}}</option>
				{{- end -}}
			    </select>
			</span>
			<noscript>
			    <button type="submit">Submit</button>
			</noscript>
		    </form>
		{{- end -}}

		{{- if gt .pageDepth 1 -}}
		    <a title="Fold" href="javascript:void(0);" onclick="toggleDisplayContent(this.closest('li'), true)" >Fold</a>&nbsp;&nbsp;
		{{- end -}}
	    {{- end -}}
	</small>
    </div>
{{- end -}}

{{define "article_reply_form" -}}
    {{$inputName := "reply_to" -}}
    {{if not .article -}}
	{{$inputName = "reply_to_tpl" -}}
    {{- end -}}
    <form id="reply_form{{if not .article}}_tpl{{- end}}" class="reply_form" method="post" action="/articles" style="{{if not .article}}display:none;{{- end}}margin-top: 20px" onkeyup="onReplyFormKeyUp(event, this)">
	{{.CSRFField -}}
	<input name="root" type="hidden" value="{{.article.ReplyRootArticleId}}"/>
	<input id="{{$inputName}}" name="{{$inputName}}" type="hidden" value="{{if .article}}{{.article.Id}}{{- end}}"/>
	<textarea required cols="30" id="content" name="content" rows="10" style="display:block;width:100%;margin-bottom:10px;box-sizing:border-box;"></textarea>

	<div class="reply-form-bottom">
	    <div>
		<button type="submit">Submit</button>
	    </div>
	    <div></div>
	</div>
    </form>
{{- end -}}

{{define "article_replies" -}}
    {{$currUser := .currUser -}}
    {{$pageDepth := .pageDepth -}}
    {{$CSRFField := .CSRFField -}}
    {{$maxDepth := .maxDepth -}}
    {{$debug := .debug -}}
    {{$reactOptions := .reactOptions -}}
    {{$reactMap := .reactMap -}}
    <ul class="replies" {{if eq $pageDepth 1}}id="replies-box"{{end}} style="{{if eq $pageDepth 1}}padding-left:0;{{- end}}">
	{{range .replies.List -}}
	    {{$subData := dict "currUser" $currUser "article" . "pageDepth" $pageDepth "CSRFField" $CSRFField "maxDepth" $maxDepth "debug" $debug "reactOptions" $reactOptions "reactMap" $reactMap -}}
	    {{- $replyNumIncludeSelf := add .TotalReplyCount 1 -}}
	    <li id="ar_{{.Id}}" data-id="{{.Id}}" data-reply-num-self-include-text="{{local "ReplyNum" "Count" $replyNumIncludeSelf}}">
		{{template "article_content" $subData -}}
	    </li>
	    {{if and (gt .TotalReplyCount 0) (eq $pageDepth $maxDepth) -}}
		<li style="padding-top:6px"><small><a href="/articles/{{.Id}}">More</a></small></li>
	    {{- end -}}
	{{- end -}}
    </ul>
{{- end -}}

